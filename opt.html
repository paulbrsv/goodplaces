<!DOCTYPE html>
<html lang="ru">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-TQDHF6DQ7Z"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-TQDHF6DQ7Z');
  </script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ö–∞—Ä—Ç–∞ –∫–æ—Ñ–µ–µ–Ω</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="opt.css">
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
</head>
<body>
  <header>
    <h1>DOBRO MESTO</h1>
    <div class="filters">
      <div class="filters-left">
        <span class="filter" data-filter="no_smoking">
          <span class="filter-icon-wrapper">
            <img src="https://paulbrsv.github.io/goodplaces/image/nosmoking.svg" alt="No smoking" class="filter-icon">
          </span>
          No smoking
        </span>
        <span class="filter" data-filter="pets_allowed">
          <span class="filter-icon-wrapper">
            <img src="https://paulbrsv.github.io/goodplaces/image/dog.svg" alt="Pet friendly" class="filter-icon">
          </span>
          Pet friendly
        </span>
        <span class="filter" data-filter="smoke">
          <span class="filter-icon-wrapper">
            <img src="https://paulbrsv.github.io/goodplaces/image/smoke.svg" alt="Non smoking area" class="filter-icon">
          </span>
          Non-smoking area
        </span>
        <span class="filter" data-filter="terrace">
          <span class="filter-icon-wrapper">
            <img src="https://paulbrsv.github.io/goodplaces/image/terrece.svg" alt="Terrace" class="filter-icon">
          </span>
          Terrace
        </span>
      </div>
      <span class="filter-divider"></span>
      <div class="filters-right">
        <span class="filter" data-filter="coffee_shop">
          <span class="filter-icon-wrapper">
            <img src="https://paulbrsv.github.io/goodplaces/image/coffee.svg" alt="Coffee" class="filter-icon">
          </span>
          Coffee
        </span>
        <span class="filter" data-filter="specialty">
          <span class="filter-icon-wrapper">
            <img src="https://paulbrsv.github.io/goodplaces/image/coffee-pot.svg" alt="Specialty coffee" class="filter-icon">
          </span>
          Specialty coffee
        </span>
        <span class="filter" data-filter="food">
          <span class="filter-icon-wrapper">
            <img src="https://paulbrsv.github.io/goodplaces/image/food.svg" alt="Food" class="filter-icon">
          </span>
          Menu
        </span>
        <span class="filter" data-filter="snacks">
          <span class="filter-icon-wrapper">
            <img src="https://paulbrsv.github.io/goodplaces/image/sandwich.svg" alt="Snacks" class="filter-icon">
          </span>
          Snacks
        </span>
        <span class="filter" data-filter="desserts">
          <span class="filter-icon-wrapper">
            <img src="https://paulbrsv.github.io/goodplaces/image/cake.svg" alt="Desserts" class="filter-icon">
          </span>
          Desserts
        </span>
        <span class="filter" data-filter="beer">
          <span class="filter-icon-wrapper">
            <img src="https://paulbrsv.github.io/goodplaces/image/beer.svg" alt="Beer" class="filter-icon">
          </span>
          Beer
        </span>
        <span class="filter" data-filter="wine">
          <span class="filter-icon-wrapper">
            <img src="https://paulbrsv.github.io/goodplaces/image/wine.svg" alt="Wine" class="filter-icon">
          </span>
          Wine
        </span>
      </div>
      <span class="filter-reset">
        <img src="https://paulbrsv.github.io/goodplaces/image/reset.svg" alt="Reset" class="filter-icon">
      </span>
    </div>
  </header>

  <div id="sidebar">
    <div class="place-list">
      <h3>–í —ç—Ç–æ–º —Ä–∞–π–æ–Ω–µ</h3>
      <div id="visible-places"></div>
    </div>
    <div class="place-list">
      <h3>üìç –ï—â—ë —Ä—è–¥–æ–º</h3>
      <div id="outside-places"></div>
    </div>
  </div>

  <div id="map"></div>

  <script>
    var map = L.map('map').setView([45.25, 19.85], 14);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
      attribution: '¬© OpenStreetMap contributors & Carto'
    }).addTo(map);

    var markerCluster = L.markerClusterGroup();
    map.addLayer(markerCluster);

    var placesData = [];
    let activeFilters = [];
    let markers = {};

    const attributeNames = {
      "specialty": '<img src="https://paulbrsv.github.io/goodplaces/image/coffee-pot.svg" alt="Specialty coffee" class="atr-icon">',
      "desserts": '<img src="https://paulbrsv.github.io/goodplaces/image/cake.svg" alt="Desserts" class="atr-icon">',
      "no_smoking": '<img src="https://paulbrsv.github.io/goodplaces/image/nosmoking.svg" alt="No smoking" class="atr-icon">',
      "pets_allowed": '<img src="https://paulbrsv.github.io/goodplaces/image/dog.svg" alt="Pet friendly" class="atr-icon">',
      "wine": '<img src="https://paulbrsv.github.io/goodplaces/image/wine.svg" alt="Wine" class="atr-icon">',
      "beer": '<img src="https://paulbrsv.github.io/goodplaces/image/beer.svg" alt="Beer" class="atr-icon">',
      "pet_friendly": '<img src="https://paulbrsv.github.io/goodplaces/image/dog.svg" alt="Pet friendly" class="atr-icon">',
      "coffee_shop": '<img src="https://paulbrsv.github.io/goodplaces/image/coffee.svg" alt="Cafe" class="atr-icon">',
      "snacks": '<img src="https://paulbrsv.github.io/goodplaces/image/sandwich.svg" alt="Snacks" class="atr-icon">',
      "food": '<img src="https://paulbrsv.github.io/goodplaces/image/food.svg" alt="Snacks" class="atr-icon">',
      "terrace": '<img src="https://paulbrsv.github.io/goodplaces/image/terrece.svg" alt="Terrace" class="atr-icon">'
    };

    const filterTooltips = {
      "no_smoking": "–ú–µ—Å—Ç–æ, –≥–¥–µ –∫—É—Ä–µ–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–ø—Ä–µ—â–µ–Ω–æ",
      "pets_allowed": "–†–∞–∑—Ä–µ—à–µ–Ω–æ –ø—Ä–∏–≤–æ–¥–∏—Ç—å –¥–æ–º–∞—à–Ω–∏—Ö –∂–∏–≤–æ—Ç–Ω—ã—Ö",
      "smoke": "–ï—Å—Ç—å –æ—Ç–¥–µ–ª—å–Ω–∞—è –∑–æ–Ω–∞ –¥–ª—è –Ω–µ–∫—É—Ä—è—â–∏—Ö",
      "terrace": "–û—Ç–∫—Ä—ã—Ç–∞—è —Ç–µ—Ä—Ä–∞—Å–∞ –¥–ª—è –æ—Ç–¥—ã—Ö–∞ –Ω–∞ —Å–≤–µ–∂–µ–º –≤–æ–∑–¥—É—Ö–µ",
      "coffee_shop": "–û–±—ã—á–Ω–∞—è –∫–æ—Ñ–µ–π–Ω—è —Å –±–∞–∑–æ–≤—ã–º –≤—ã–±–æ—Ä–æ–º –Ω–∞–ø–∏—Ç–∫–æ–≤",
      "specialty": "–ö–æ—Ñ–µ–π–Ω—è —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ —Å–æ—Ä—Ç–∞–º–∏ –∫–æ—Ñ–µ –∏ –∞–≤—Ç–æ—Ä—Å–∫–∏–º–∏ –Ω–∞–ø–∏—Ç–∫–∞–º–∏",
      "food": "–ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ –º–µ–Ω—é —Å –≥–æ—Ä—è—á–∏–º–∏ –±–ª—é–¥–∞–º–∏",
      "snacks": "–õ—ë–≥–∫–∏–µ –∑–∞–∫—É—Å–∫–∏ –∫ –Ω–∞–ø–∏—Ç–∫–∞–º",
      "desserts": "–®–∏—Ä–æ–∫–∏–π –≤—ã–±–æ—Ä —Å–ª–∞–¥–æ—Å—Ç–µ–π –∏ –≤—ã–ø–µ—á–∫–∏",
      "beer": "–ü—Ä–µ–¥–ª–∞–≥–∞—é—Ç –ø–∏–≤–æ –≤ –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç–µ",
      "wine": "–ï—Å—Ç—å –≤—ã–±–æ—Ä –≤–∏–Ω"
    };

    const attributeTooltips = {
      "no_smoking": "–ö—É—Ä–µ–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –≤–æ –≤—Å–µ—Ö –∑–æ–Ω–∞—Ö",
      "pets_allowed": "–ú–æ–∂–Ω–æ —Å –ø–∏—Ç–æ–º—Ü–∞–º–∏",
      "smoke": "–û—Ç–¥–µ–ª—å–Ω–∞—è –∑–æ–Ω–∞ –±–µ–∑ –¥—ã–º–∞",
      "terrace": "–£—é—Ç–Ω–∞—è —Ç–µ—Ä—Ä–∞—Å–∞ –Ω–∞ —É–ª–∏—Ü–µ",
      "coffee_shop": "–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –∫–æ—Ñ–µ–π–Ω—è",
      "specialty": "–û—Å–æ–±—ã–π –∫–æ—Ñ–µ –æ—Ç –±–∞—Ä–∏—Å—Ç–∞",
      "food": "–ì–æ—Ä—è—á–∏–µ –±–ª—é–¥–∞ –≤ –º–µ–Ω—é",
      "snacks": "–ë—ã—Å—Ç—Ä—ã–µ –ø–µ—Ä–µ–∫—É—Å—ã",
      "desserts": "–°–ª–∞–¥–æ—Å—Ç–∏ –Ω–∞ –ª—é–±–æ–π –≤–∫—É—Å",
      "beer": "–ü–∏–≤–Ω–æ–π –∞—Å—Å–æ—Ä—Ç–∏–º–µ–Ω—Ç",
      "wine": "–í–∏–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞",
      "pet_friendly": "–î—Ä—É–∂–µ–ª—é–±–Ω–æ –∫ –ø–∏—Ç–æ–º—Ü–∞–º"
    };

    document.querySelectorAll('.filter').forEach(filter => {
      filter.addEventListener('click', () => {
        const filterId = filter.dataset.filter;
        if (!filterId) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º filter-reset
        if (activeFilters.includes(filterId)) {
          activeFilters = activeFilters.filter(f => f !== filterId);
          filter.classList.remove('active');
        } else {
          activeFilters.push(filterId);
          filter.classList.add('active');
        }
        updateMap();
      });
    });

    document.querySelector('.filter-reset').addEventListener('click', () => {
      activeFilters = [];
      document.querySelectorAll('.filter').forEach(filter => filter.classList.remove('active'));
      updateMap();
    });

    function updateMap() {
      markerCluster.clearLayers();
      const filteredPlaces = placesData.filter(place => {
        if (activeFilters.length === 0) return true;
        return activeFilters.every(filter => place.attributes.includes(filter));
      });

      filteredPlaces.forEach(place => {
        const popupContent = `
          <div class="popup-content">
            <img src="${place.image}" alt="${place.name}">
            <div class="popup-text">
              <div class="popup-text-content">
                <h3>${place.name}</h3>
                <p>${place.description}</p>
                <div class="popup-attributes">${place.attributes.map(attr => attributeNames[attr] || attr).join('')}</div>
              </div>
              <div class="popup-links">
                <a href="${place.instagram}" target="_blank">
                  <img src="https://paulbrsv.github.io/goodplaces/image/instagram.svg" alt="Instagram" class="icon">
                </a>
                <a href="https://www.google.com/maps/search/?api=1&query=${place.lat},${place.lng}" target="_blank">
                  <img src="https://paulbrsv.github.io/goodplaces/image/google.svg" alt="Google Maps" class="icon">
                </a>
              </div>
            </div>
          </div>
        `;
        const marker = L.marker([place.lat, place.lng]).bindPopup(popupContent, {
          autoPan: true,
          autoPanPaddingTopLeft: L.point(0, 100),
          autoPanPaddingBottomRight: L.point(0, 50)
        });
        markerCluster.addLayer(marker);
        markers[place.name] = marker;
      });

      if (!map.hasLayer(markerCluster)) {
        map.addLayer(markerCluster);
      }

      updateSidebar(filteredPlaces);
      updateFilterCounts(filteredPlaces); // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫–∏
    }

    function updateFilterCounts(filteredPlaces) {
      document.querySelectorAll('.filter').forEach(filter => {
        const filterId = filter.dataset.filter;
        if (!filterId) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º filter-reset
        const count = filteredPlaces.filter(place => place.attributes.includes(filterId)).length;
        let countElement = filter.querySelector('.filter-count');
        if (!countElement) {
          countElement = document.createElement('div');
          countElement.classList.add('filter-count');
          filter.appendChild(countElement);
        }
        countElement.textContent = count;
      });
    }

    function updateSidebar(filteredPlaces) {
      const visibleList = document.getElementById("visible-places");
      const outsideList = document.getElementById("outside-places");
      visibleList.innerHTML = "";
      outsideList.innerHTML = "";

      const bounds = map.getBounds();
      filteredPlaces.forEach(place => {
        const placeElement = document.createElement("div");
        placeElement.className = "place";
        placeElement.innerHTML = `
          <img src="${place.image}" alt="${place.name}">
          <div class="place-info">
            <h3>${place.name}</h3>
            <p>${place.shirt_description}</p>
            <p>${place.attributes.map(attr => attributeNames[attr] || attr).join('')}</p>
          </div>
        `;
        placeElement.onclick = () => {
          map.setView([place.lat, place.lng], 18, { animate: true });
          map.removeLayer(markerCluster);
          markers[place.name].addTo(map);
          markers[place.name].openPopup();
          if (!map.hasLayer(markerCluster)) {
            map.addLayer(markerCluster);
          }
          markers[place.name].off("popupclose");
          markers[place.name].on("popupclose", () => {
            map.removeLayer(markers[place.name]);
            if (!map.hasLayer(markerCluster)) {
              map.addLayer(markerCluster);
            }
            updateMap();
          });
        };

        if (bounds.contains([place.lat, place.lng])) {
          visibleList.appendChild(placeElement);
        } else {
          outsideList.appendChild(placeElement);
        }
      });
    }

    // –¢—É–ª—Ç–∏–ø—ã –Ω–∞ —á–∏—Å—Ç–æ–º JS
    document.addEventListener('DOMContentLoaded', () => {
      function showTooltip(element, text) {
        let tooltip = element.querySelector('.custom-tooltip');
        if (!tooltip) {
          tooltip = document.createElement('div');
          tooltip.className = 'custom-tooltip';
          tooltip.textContent = text;
          element.appendChild(tooltip);
        }
        const rect = element.getBoundingClientRect();
        tooltip.style.top = `-${tooltip.offsetHeight + 5}px`;
        tooltip.style.left = `${(element.offsetWidth - tooltip.offsetWidth) / 2}px`;
        tooltip.style.visibility = 'visible';
      }

      function hideTooltip(element) {
        const tooltip = element.querySelector('.custom-tooltip');
        if (tooltip) {
          tooltip.style.visibility = 'hidden';
        }
      }

      // –¢—É–ª—Ç–∏–ø—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
      const filters = document.querySelectorAll('.filter');
      filters.forEach(filter => {
        const filterId = filter.dataset.filter;
        if (!filterId) return; // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º filter-reset
        const tooltipText = filterTooltips[filterId] || "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";
        filter.addEventListener('mouseenter', () => showTooltip(filter, tooltipText));
        filter.addEventListener('mouseleave', () => hideTooltip(filter));
      });

      // –¢—É–ª—Ç–∏–ø—ã –¥–ª—è –∞—Ç—Ä–∏–±—É—Ç–æ–≤
      function updateTooltips() {
        const attributeIcons = document.querySelectorAll('.atr-icon');
        attributeIcons.forEach(icon => {
          if (!icon.parentElement.classList.contains('attribute-icon-wrapper')) {
            const attributeName = Object.keys(attributeNames).find(key =>
              attributeNames[key].includes(icon.src)
            );
            if (attributeName) {
              const tooltipText = attributeTooltips[attributeName] || attributeName.replace('_', ' ');
              const tooltipWrapper = document.createElement('span');
              tooltipWrapper.className = 'attribute-icon-wrapper';
              icon.parentNode.insertBefore(tooltipWrapper, icon);
              tooltipWrapper.appendChild(icon);
              tooltipWrapper.addEventListener('mouseenter', () => showTooltip(tooltipWrapper, tooltipText));
              tooltipWrapper.addEventListener('mouseleave', () => hideTooltip(tooltipWrapper));
            }
          }
        });
      }

      fetch('places.json')
        .then(response => response.json())
        .then(data => {
          placesData = data;
          updateMap();
          updateTooltips();
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error));

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—É–ª—Ç–∏–ø—ã –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
      map.on('moveend', () => {
        updateSidebar(placesData.filter(place => {
          if (activeFilters.length === 0) return true;
          return place.attributes.some(attr => activeFilters.includes(attr));
        }));
        updateTooltips();
      });

      map.on('popupopen', () => {
        setTimeout(updateTooltips, 100); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—É–ª—Ç–∏–ø—ã –ø–æ—Å–ª–µ –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–æ–ø–∞–ø–∞
      });

      // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º updateMap –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
      const originalUpdateMap = updateMap;
      updateMap = function() {
        originalUpdateMap.apply(this, arguments);
        setTimeout(updateTooltips, 100); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç—É–ª—Ç–∏–ø—ã –ø–æ—Å–ª–µ —Ä–µ–Ω–¥–µ—Ä–∞
      };
    });
  </script>
</body>
</html>
