<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ –∫–æ—Ñ–µ–µ–Ω</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <link rel="stylesheet" href="mobile.css">
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>

<header>
    <h1>GOOD PLACES</h1>
    <div class="filters">
        <span class="filter" data-filter="specialty">–°–ø–µ—à–µ–ª—Ç–∏</span>
        <span class="filter" data-filter="desserts">–î–µ—Å–µ—Ä—Ç—ã</span>
        <span class="filter" data-filter="no_smoking">–ù–µ –∫—É—Ä—è—Ç</span>
        <span class="filter" data-filter="pets_allowed">–ú–æ–∂–Ω–æ —Å –∂–∏–≤–æ—Ç–Ω—ã–º–∏</span>
    </div>
</header>

<div id="sidebar">
    <h2>–ö–æ—Ñ–µ–π–Ω–∏</h2>
    <div class="place-list">
        <h3>üìç –í —ç—Ç–æ–º —Ä–∞–π–æ–Ω–µ</h3>
        <div id="visible-places"></div>
    </div>
    <div class="place-list">
        <h3>üåç –ó–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏</h3>
        <div id="outside-places"></div>
    </div>
</div>

<div id="map"></div>

<!-- –ö–∞—Å—Ç–æ–º–Ω—ã–π –ø–æ–ø–∞–ø -->
<div id="custom-popup" style="display: none;">
    <div class="popup-content">
        <span class="popup-close" id="popup-close">‚úñ</span>
        <img id="popup-image" src="" alt="">
        <div class="popup-text">
            <h3 id="popup-name"></h3>
            <p id="popup-description"></p>
            <div id="popup-attributes"></div>
            <div class="popup-links">
                <a id="popup-link-website" href="" target="_blank">üåê –°–∞–π—Ç</a>
                <a id="popup-link-instagram" href="" target="_blank">üì∏ Instagram</a>
                <a id="popup-link-map" href="" target="_blank">üìç –ö–∞—Ä—Ç–∞</a>
            </div>
        </div>
    </div>
</div>

<script>
    var map = L.map('map').setView([45.25, 19.85], 14);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap contributors & Carto'
    }).addTo(map);

    var markers = [];
    var placesData = [];
    let activeFilters = [];

    // –û–±—ä–µ–∫—Ç —Å –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏ –∞—Ç—Ä–∏–±—É—Ç–æ–≤
    const attributeNames = {
        "specialty": "‚òï –°–ø–µ—à–µ–ª—Ç–∏ –∫–æ—Ñ–µ",
        "desserts": "üç∞ –î–µ—Å–µ—Ä—Ç—ã",
        "no_smoking": "üö≠ –ù–µ –∫—É—Ä—è—Ç",
        "pets_allowed": "üêæ –ú–æ–∂–Ω–æ —Å –∂–∏–≤–æ—Ç–Ω—ã–º–∏"
    };

    document.querySelectorAll('.filter').forEach(filter => {
        // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å hover –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –º—ã—à–∏
        filter.addEventListener('mouseenter', () => {
            filter.style.backgroundColor = '#e0e0e0';  // –¶–≤–µ—Ç –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
        });

        // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å hover –ø—Ä–∏ —É—Ö–æ–¥–µ –º—ã—à–∏
        filter.addEventListener('mouseleave', () => {
            filter.style.backgroundColor = '';  // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ü–≤–µ—Ç
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞
        filter.addEventListener('click', () => {
            const filterId = filter.dataset.filter;

            // –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä —É–∂–µ –∞–∫—Ç–∏–≤–µ–Ω, —É–¥–∞–ª—è–µ–º –µ–≥–æ
            if (activeFilters.includes(filterId)) {
                activeFilters = activeFilters.filter(f => f !== filterId);
                filter.classList.remove('active');
            } else {
                // –ï—Å–ª–∏ —Ñ–∏–ª—å—Ç—Ä –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ
                activeFilters.push(filterId);
                filter.classList.add('active');
            }

            // –°–Ω–∏–º–∞–µ–º —Ñ–æ–∫—É—Å —Å –∫–Ω–æ–ø–∫–∏
            filter.blur();

            // –£–±–∏—Ä–∞–µ–º —Å—Ç–∏–ª—å hover —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –∫–ª–∏–∫–∞
            filter.style.backgroundColor = '';  // –°–Ω–∏–º–∞–µ–º —Ü–≤–µ—Ç hover

            updateMap();
        });
    });

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞—Ä—Ç—ã
    function updateMap() {
        const filteredPlaces = placesData.filter(place => {
            if (activeFilters.length === 0) return true;
            return place.attributes.some(attr => activeFilters.includes(attr));
        });

        console.log('Filtered Places:', filteredPlaces); // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

        markers.forEach(marker => marker.remove());
        markers = [];

        filteredPlaces.forEach(place => {
            const attributeLabels = place.attributes.map(attr => attributeNames[attr] || attr).join(' | ');

            const popupContent = `
                <div class="popup-content">
                    <img src="${place.image}" alt="${place.name}">
                    <div class="popup-text">
                        <h3>${place.name}</h3>
                        <p>${place.description}</p>
                        <div class="popup-attributes">${attributeLabels}</div>
                        <div class="popup-links">
                            <a href="${place.link}" target="_blank">üåê –°–∞–π—Ç</a>
                            <a href="${place.instagram}" target="_blank">üì∏ Instagram</a>
                            <a href="https://www.google.com/maps/search/?api=1&query=${place.lat},${place.lng}" target="_blank">üìç –ö–∞—Ä—Ç–∞</a>
                        </div>
                    </div>
                </div>
            `;
            const marker = L.marker([place.lat, place.lng])
                .addTo(map)
                .on('click', function() {
                    openCustomPopup(place);
                });
            marker.placeName = place.name;
            markers.push(marker);
        });
        updateSidebar(filteredPlaces);
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –ø–æ–ø–∞–ø–∞
    function openCustomPopup(place) {
        document.getElementById('popup-image').src = place.image;
        document.getElementById('popup-name').innerText = place.name;
        document.getElementById('popup-description').innerText = place.description;
        document.getElementById('popup-attributes').innerHTML = place.attributes.map(attr => attributeNames[attr] || attr).join(' | ');
        document.getElementById('popup-link-website').href = place.link;
        document.getElementById('popup-link-instagram').href = place.instagram;
        document.getElementById('popup-link-map').href = `https://www.google.com/maps/search/?api=1&query=${place.lat},${place.lng}`;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã–π –ø–æ–ø–∞–ø
        document.getElementById('custom-popup').style.display = 'block';
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è –ø–æ–ø–∞–ø–∞
    document.getElementById('popup-close').addEventListener('click', function() {
        document.getElementById('custom-popup').style.display = 'none';
    });

    // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
    function updateSidebar(filteredPlaces) {
        const visibleList = document.getElementById("visible-places");
        const outsideList = document.getElementById("outside-places");
        visibleList.innerHTML = "";
        outsideList.innerHTML = "";

        const bounds = map.getBounds();
        filteredPlaces.forEach(place => {
            const placeElement = document.createElement("div");
            placeElement.className = "place";
            placeElement.innerHTML = `
                <img src="${place.image}" alt="${place.name}">
                <div class="place-info">
                    <h3>${place.name}</h3>
                    <p>${place.description}</p>
                </div>
            `;
            placeElement.onclick = () => {
                map.setView([place.lat, place.lng], 16, { animate: true });
                setTimeout(() => {
                    markers.find(m => m.placeName === place.name).openPopup();
                }, 300);
            };
            if (bounds.contains([place.lat, place.lng])) {
                visibleList.appendChild(placeElement);
            } else {
                outsideList.appendChild(placeElement);
            }
        });
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞
    fetch('places.json')
        .then(response => response.json())
        .then(data => {
            placesData = data;
            updateMap();
        })
        .catch(error => console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error));

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ–±–ª–∞—Å—Ç–∏ –∫–∞—Ä—Ç—ã
    map.on('moveend', () => updateSidebar(placesData.filter(place => {
        if (activeFilters.length === 0) return true;
        return place.attributes.some(attr => activeFilters.includes(attr));
    })));
</script>

</body>
</html>
